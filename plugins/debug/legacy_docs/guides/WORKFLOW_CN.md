# GitHub Copilot SDK é›†æˆå·¥ä½œæµç¨‹

**ä½œè€…ï¼š** Fu-Jie  
**ç‰ˆæœ¬ï¼š** 0.2.3  
**æœ€åæ›´æ–°ï¼š** 2026-01-27

---

## ç›®å½•

1. [æ¶æ„æ¦‚è§ˆ](#æ¶æ„æ¦‚è§ˆ)
2. [è¯·æ±‚å¤„ç†æµç¨‹](#è¯·æ±‚å¤„ç†æµç¨‹)
3. [ä¼šè¯ç®¡ç†](#ä¼šè¯ç®¡ç†)
4. [æµå¼å“åº”å¤„ç†](#æµå¼å“åº”å¤„ç†)
5. [äº‹ä»¶å¤„ç†æœºåˆ¶](#äº‹ä»¶å¤„ç†æœºåˆ¶)
6. [å·¥å…·æ‰§è¡Œæµç¨‹](#å·¥å…·æ‰§è¡Œæµç¨‹)
7. [ç³»ç»Ÿæç¤ºè¯æå–](#ç³»ç»Ÿæç¤ºè¯æå–)
8. [é…ç½®å‚æ•°](#é…ç½®å‚æ•°)
9. [æ ¸å¿ƒå‡½æ•°å‚è€ƒ](#æ ¸å¿ƒå‡½æ•°å‚è€ƒ)

---

## æ¶æ„æ¦‚è§ˆ

### ç»„ä»¶å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       OpenWebUI                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              Pipe æ¥å£ (å…¥å£ç‚¹)                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                        â”‚                                     â”‚
â”‚                        â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           _pipe_impl (ä¸»é€»è¾‘)                         â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ 1. ç¯å¢ƒè®¾ç½® (_setup_env)                        â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ 2. æ¨¡å‹é€‰æ‹© (request_model è§£æ)                â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ 3. èŠå¤©ä¸Šä¸‹æ–‡æå–                                â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ 4. ç³»ç»Ÿæç¤ºè¯æå–                                â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ 5. ä¼šè¯ç®¡ç† (åˆ›å»º/æ¢å¤)                          â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ 6. æµå¼/éæµå¼å“åº”                               â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                        â”‚                                     â”‚
â”‚                        â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           GitHub Copilot å®¢æˆ·ç«¯                       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ CopilotClient (SDK å®ä¾‹)                       â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Session (å¯¹è¯ä¸Šä¸‹æ–‡)                           â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Event Stream (å¼‚æ­¥äº‹ä»¶æµ)                      â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                        â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Copilot CLI è¿›ç¨‹    â”‚
              â”‚  (åç«¯ä»£ç†)          â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶

1. **Pipe æ¥å£**ï¼šOpenWebUI çš„æ ‡å‡†å…¥å£ç‚¹
2. **ç¯å¢ƒç®¡ç†å™¨**ï¼šCLI è®¾ç½®ã€ä»¤ç‰ŒéªŒè¯ã€ç¯å¢ƒå˜é‡
3. **ä¼šè¯ç®¡ç†å™¨**ï¼šæŒä¹…åŒ–å¯¹è¯çŠ¶æ€ï¼Œè‡ªåŠ¨å‹ç¼©
4. **äº‹ä»¶å¤„ç†å™¨**ï¼šå¼‚æ­¥æµå¼äº‹ä»¶å¤„ç†å™¨
5. **å·¥å…·ç³»ç»Ÿ**ï¼šè‡ªå®šä¹‰å·¥å…·æ³¨å†Œå’Œæ‰§è¡Œ
6. **è°ƒè¯•æ—¥å¿—å™¨**ï¼šå‰ç«¯æ§åˆ¶å°æ—¥å¿—ï¼Œç”¨äºæ•…éšœæ’é™¤

---

## è¯·æ±‚å¤„ç†æµç¨‹

### å®Œæ•´è¯·æ±‚ç”Ÿå‘½å‘¨æœŸ

```mermaid
graph TD
    A[OpenWebUI è¯·æ±‚] --> B[pipe å…¥å£ç‚¹]
    B --> C[_pipe_impl]
    C --> D{è®¾ç½®ç¯å¢ƒ}
    D --> E[è§£ææ¨¡å‹ ID]
    E --> F[æå–èŠå¤©ä¸Šä¸‹æ–‡]
    F --> G[æå–ç³»ç»Ÿæç¤ºè¯]
    G --> H{ä¼šè¯å­˜åœ¨?}
    H -->|æ˜¯| I[æ¢å¤ä¼šè¯]
    H -->|å¦| J[åˆ›å»ºæ–°ä¼šè¯]
    I --> K[åˆå§‹åŒ–å·¥å…·]
    J --> K
    K --> L[å¤„ç†å›¾ç‰‡]
    L --> M{æµå¼æ¨¡å¼?}
    M -->|æ˜¯| N[stream_response]
    M -->|å¦| O[send_and_wait]
    N --> P[å¼‚æ­¥äº‹ä»¶æµ]
    O --> Q[ç›´æ¥å“åº”]
    P --> R[è¿”å›åˆ° OpenWebUI]
    Q --> R
```

### é€æ­¥åˆ†è§£

#### 1. ç¯å¢ƒè®¾ç½® (`_setup_env`)

```python
def _setup_env(self, __event_call__=None):
    """
    ä¼˜å…ˆçº§ï¼š
    1. æ£€æŸ¥ VALVES.CLI_PATH
    2. æœç´¢ç³»ç»Ÿ PATH
    3. è‡ªåŠ¨é€šè¿‡ curl å®‰è£…ï¼ˆå¦‚æœæœªæ‰¾åˆ°ï¼‰
    4. è®¾ç½® GH_TOKEN ç¯å¢ƒå˜é‡
    """
```

**æ“ä½œï¼š**

- å®šä½ Copilot CLI äºŒè¿›åˆ¶æ–‡ä»¶
- è®¾ç½® `COPILOT_CLI_PATH` ç¯å¢ƒå˜é‡
- é…ç½® `GH_TOKEN` è¿›è¡Œèº«ä»½éªŒè¯
- åº”ç”¨è‡ªå®šä¹‰ç¯å¢ƒå˜é‡

#### 2. æ¨¡å‹é€‰æ‹©

```python
# è¾“å…¥ï¼šbody["model"] = "copilotsdk-claude-sonnet-4.5"
request_model = body.get("model", "")
if request_model.startswith(f"{self.id}-"):
    real_model_id = request_model[len(f"{self.id}-"):]  # "claude-sonnet-4.5"
```

#### 3. èŠå¤©ä¸Šä¸‹æ–‡æå– (`_get_chat_context`)

```python
# chat_id çš„ä¼˜å…ˆçº§é¡ºåºï¼š
# 1. __metadata__ï¼ˆæœ€å¯é ï¼‰
# 2. body["chat_id"]
# 3. body["metadata"]["chat_id"]
chat_ctx = self._get_chat_context(body, __metadata__, __event_call__)
chat_id = chat_ctx.get("chat_id")
```

#### 4. ç³»ç»Ÿæç¤ºè¯æå– (`_extract_system_prompt`)

å¤šæºå›é€€ç­–ç•¥ï¼š

1. `metadata.model.params.system`
2. æ¨¡å‹æ•°æ®åº“æŸ¥è¯¢ï¼ˆæŒ‰ model_idï¼‰
3. `body.params.system`
4. åŒ…å« `role="system"` çš„æ¶ˆæ¯

#### 5. ä¼šè¯åˆ›å»º/æ¢å¤

**æ–°ä¼šè¯ï¼š**

```python
session_config = SessionConfig(
    session_id=chat_id,
    model=real_model_id,
    streaming=is_streaming,
    tools=custom_tools,
    system_message={"mode": "append", "content": system_prompt_content},
    infinite_sessions=InfiniteSessionConfig(
        enabled=True,
        background_compaction_threshold=0.8,
        buffer_exhaustion_threshold=0.95
    )
)
session = await client.create_session(config=session_config)
```

**æ¢å¤ä¼šè¯ï¼š**

```python
try:
    session = await client.resume_session(chat_id)
    # ä¼šè¯çŠ¶æ€ä¿ç•™ï¼šå†å²ã€å·¥å…·ã€å·¥ä½œåŒº
except Exception:
    # å›é€€åˆ°åˆ›å»ºæ–°ä¼šè¯
```

---

## ä¼šè¯ç®¡ç†

### æ— é™ä¼šè¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ä¼šè¯ç”Ÿå‘½å‘¨æœŸ                                â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  åˆ›å»º  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  æ¢å¤   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Chat ID  â”‚â”€â”€â”€â”€â”€â–¶ â”‚ Session  â”‚ â—€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  OpenWebUI â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚  State   â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                         â”‚
â”‚                           â”‚                              â”‚
â”‚                           â–¼                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚          ä¸Šä¸‹æ–‡çª—å£ç®¡ç†                          â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚ æ¶ˆæ¯ [user, assistant, tool_results...]  â”‚  â”‚    â”‚
â”‚  â”‚  â”‚ Token ä½¿ç”¨ç‡: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘ (80%)     â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â”‚                      â”‚                          â”‚    â”‚
â”‚  â”‚                      â–¼                          â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚  è¾¾åˆ°é˜ˆå€¼ (0.8)                          â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â†’ åå°å‹ç¼©è§¦å‘                          â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â”‚                      â”‚                          â”‚    â”‚
â”‚  â”‚                      â–¼                          â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚  å‹ç¼©æ‘˜è¦ + æœ€è¿‘æ¶ˆæ¯                     â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  Token ä½¿ç”¨ç‡: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ (40%)  â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é…ç½®å‚æ•°

```python
InfiniteSessionConfig(
    enabled=True,                              # å¯ç”¨æ— é™ä¼šè¯
    background_compaction_threshold=0.8,       # åœ¨ 80% token ä½¿ç”¨ç‡æ—¶å¼€å§‹å‹ç¼©
    buffer_exhaustion_threshold=0.95           # 95% ç´§æ€¥é˜ˆå€¼
)
```

**è¡Œä¸ºï¼š**

- **< 80%**ï¼šæ­£å¸¸æ“ä½œï¼Œæ— å‹ç¼©
- **80-95%**ï¼šåå°å‹ç¼©ï¼ˆæ€»ç»“æ—§æ¶ˆæ¯ï¼‰
- **> 95%**ï¼šåœ¨ä¸‹ä¸€ä¸ªè¯·æ±‚å‰å¼ºåˆ¶å‹ç¼©

---

## æµå¼å“åº”å¤„ç†

### äº‹ä»¶é©±åŠ¨æ¶æ„

```python
async def stream_response(
    self, client, session, send_payload, init_message: str = "", __event_call__=None
) -> AsyncGenerator:
    """
    ä½¿ç”¨åŸºäºé˜Ÿåˆ—çš„ç¼“å†²è¿›è¡Œå¼‚æ­¥äº‹ä»¶å¤„ç†ã€‚
    
    æµç¨‹ï¼š
    1. å¯åŠ¨å¼‚æ­¥å‘é€ä»»åŠ¡
    2. æ³¨å†Œäº‹ä»¶å¤„ç†å™¨
    3. é€šè¿‡é˜Ÿåˆ—å¤„ç†äº‹ä»¶
    4. å‘ OpenWebUI äº§å‡ºå—
    5. æ¸…ç†èµ„æº
    """
```

### äº‹ä»¶å¤„ç†ç®¡é“

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Copilot SDK äº‹ä»¶æµ                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  äº‹ä»¶å¤„ç†å™¨            â”‚
        â”‚  (åŒæ­¥å›è°ƒ)            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  å¼‚æ­¥é˜Ÿåˆ—              â”‚
        â”‚  (çº¿ç¨‹å®‰å…¨)            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  æ¶ˆè´¹è€…å¾ªç¯            â”‚
        â”‚  (async for)           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  yield åˆ° OpenWebUI    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æµå¼ä¼ è¾“æœŸé—´çš„çŠ¶æ€ç®¡ç†

```python
state = {
    "thinking_started": False,   # <think> æ ‡ç­¾å·²æ‰“å¼€
    "content_sent": False        # ä¸»å†…å®¹å·²å¼€å§‹
}
active_tools = {}  # è·Ÿè¸ªå¹¶å‘å·¥å…·æ‰§è¡Œ
```

**çŠ¶æ€è½¬æ¢ï¼š**

1. `reasoning_delta` åˆ°è¾¾ â†’ `thinking_started = True` â†’ è¾“å‡ºï¼š`<think>\n{reasoning}`
2. `message_delta` åˆ°è¾¾ â†’ å¦‚æœæ‰“å¼€åˆ™å…³é—­ `</think>` â†’ `content_sent = True` â†’ è¾“å‡ºï¼š`{content}`
3. `tool.execution_start` â†’ è¾“å‡ºå·¥å…·æŒ‡ç¤ºå™¨ï¼ˆåœ¨ `<think>` å†…éƒ¨/å¤–éƒ¨ï¼‰
4. `session.complete` â†’ å®Œæˆæµ

---

## äº‹ä»¶å¤„ç†æœºåˆ¶

### äº‹ä»¶ç±»å‹å‚è€ƒ

éµå¾ªå®˜æ–¹ SDK æ¨¡å¼ï¼ˆæ¥è‡ª `copilot.SessionEventType`ï¼‰ï¼š

| äº‹ä»¶ç±»å‹ | æè¿° | å…³é”®æ•°æ®å­—æ®µ | å¤„ç†å™¨æ“ä½œ |
|---------|------|-------------|-----------|
| `assistant.message_delta` | ä¸»å†…å®¹æµå¼ä¼ è¾“ | `delta_content` | äº§å‡ºæ–‡æœ¬å— |
| `assistant.reasoning_delta` | æ€ç»´é“¾ | `delta_content` | ç”¨ `<think>` æ ‡ç­¾åŒ…è£… |
| `tool.execution_start` | å·¥å…·è°ƒç”¨å¯åŠ¨ | `name`, `tool_call_id` | æ˜¾ç¤ºå·¥å…·æŒ‡ç¤ºå™¨ |
| `tool.execution_complete` | å·¥å…·å®Œæˆ | `result.content` | æ˜¾ç¤ºå®ŒæˆçŠ¶æ€ |
| `session.compaction_start` | ä¸Šä¸‹æ–‡å‹ç¼©å¼€å§‹ | - | è®°å½•è°ƒè¯•ä¿¡æ¯ |
| `session.compaction_complete` | å‹ç¼©å®Œæˆ | - | è®°å½•è°ƒè¯•ä¿¡æ¯ |
| `session.error` | å‘ç”Ÿé”™è¯¯ | `error`, `message` | å‘å‡ºé”™è¯¯é€šçŸ¥ |

### äº‹ä»¶å¤„ç†å™¨å®ç°

```python
def handler(event):
    """éµå¾ªå®˜æ–¹ SDK æ¨¡å¼å¤„ç†æµå¼äº‹ä»¶ã€‚"""
    event_type = get_event_type(event)  # å¤„ç†æšä¸¾/å­—ç¬¦ä¸²ç±»å‹
    
    # ä½¿ç”¨ safe_get_data_attr æå–æ•°æ®ï¼ˆå¤„ç† dict/objectï¼‰
    if event_type == "assistant.message_delta":
        delta = safe_get_data_attr(event, "delta_content")
        if delta:
            queue.put_nowait(delta)  # çº¿ç¨‹å®‰å…¨å…¥é˜Ÿ
```

### å®˜æ–¹ SDK æ¨¡å¼åˆè§„æ€§

```python
def safe_get_data_attr(event, attr: str, default=None):
    """
    å®˜æ–¹æ¨¡å¼ï¼ševent.data.delta_content
    å¤„ç† dict å’Œå¯¹è±¡è®¿é—®æ¨¡å¼ã€‚
    """
    if not hasattr(event, "data") or event.data is None:
        return default
    
    data = event.data
    
    # Dict è®¿é—®ï¼ˆç±»ä¼¼ JSONï¼‰
    if isinstance(data, dict):
        return data.get(attr, default)
    
    # å¯¹è±¡å±æ€§ï¼ˆPython SDKï¼‰
    return getattr(data, attr, default)
```

---

## å·¥å…·æ‰§è¡Œæµç¨‹

### å·¥å…·æ³¨å†Œ

```python
# 1. åœ¨æ¨¡å—çº§åˆ«å®šä¹‰å·¥å…·
@define_tool(description="åœ¨æŒ‡å®šèŒƒå›´å†…ç”Ÿæˆéšæœºæ•´æ•°ã€‚")
async def generate_random_number(params: RandomNumberParams) -> str:
    number = random.randint(params.min, params.max)
    return f"ç”Ÿæˆçš„éšæœºæ•°: {number}"

# 2. åœ¨ _initialize_custom_tools ä¸­æ³¨å†Œ
def _initialize_custom_tools(self):
    if not self.valves.ENABLE_TOOLS:
        return []
    
    all_tools = {
        "generate_random_number": generate_random_number,
    }
    
    # æ ¹æ® AVAILABLE_TOOLS valve è¿‡æ»¤
    if self.valves.AVAILABLE_TOOLS == "all":
        return list(all_tools.values())
    
    enabled = [t.strip() for t in self.valves.AVAILABLE_TOOLS.split(",")]
    return [all_tools[name] for name in enabled if name in all_tools]
```

### å·¥å…·æ‰§è¡Œæ—¶é—´çº¿

```
ç”¨æˆ·æ¶ˆæ¯ï¼šç”Ÿæˆä¸€ä¸ª 1 åˆ° 100 ä¹‹é—´çš„éšæœºæ•°
     â”‚
     â–¼
æ¨¡å‹å†³ç­–ï¼šä½¿ç”¨å·¥å…· `generate_random_number`
     â”‚
     â–¼
äº‹ä»¶ï¼štool.execution_start
     â”‚  â†’ æ˜¾ç¤ºï¼š"ğŸ”§ è¿è¡Œå·¥å…·ï¼šgenerate_random_number"
     â–¼
å·¥å…·å‡½æ•°æ‰§è¡Œï¼ˆå¼‚æ­¥ï¼‰
     â”‚
     â–¼
äº‹ä»¶ï¼štool.execution_complete
     â”‚  â†’ ç»“æœï¼š"ç”Ÿæˆçš„éšæœºæ•°ï¼š42"
     â”‚  â†’ æ˜¾ç¤ºï¼š"âœ… å·¥å…·å®Œæˆï¼š42"
     â–¼
æ¨¡å‹ä½¿ç”¨å·¥å…·ç»“æœç”Ÿæˆå“åº”
     â”‚
     â–¼
äº‹ä»¶ï¼šassistant.message_delta
     â”‚  â†’ "æˆ‘ä¸ºä½ ç”Ÿæˆäº†æ•°å­— 42ã€‚"
     â–¼
æµå®Œæˆ
```

### è§†è§‰æŒ‡ç¤ºå™¨

**å†…å®¹å‰ï¼š**

```markdown
<think>
è¿è¡Œå·¥å…·ï¼šgenerate_random_number...
å·¥å…· `generate_random_number` å®Œæˆã€‚ç»“æœï¼š42
</think>

æˆ‘ä¸ºä½ ç”Ÿæˆäº†æ•°å­— 42ã€‚
```

**å†…å®¹å¼€å§‹åï¼š**

```markdown
æ•°å­—æ˜¯

> ğŸ”§ **è¿è¡Œå·¥å…·**ï¼š`generate_random_number`

> âœ… **å·¥å…·å®Œæˆ**ï¼š42

å®é™…ä¸Šæ˜¯ 42ã€‚
```

---

## ç³»ç»Ÿæç¤ºè¯æå–

### å¤šæºä¼˜å…ˆçº§ç³»ç»Ÿ

```python
async def _extract_system_prompt(self, body, messages, request_model, real_model_id):
    """
    ä¼˜å…ˆçº§é¡ºåºï¼š
    1. metadata.model.params.systemï¼ˆæœ€é«˜ï¼‰
    2. æ¨¡å‹æ•°æ®åº“æŸ¥è¯¢
    3. body.params.system
    4. messages[role="system"]ï¼ˆå›é€€ï¼‰
    """
```

### æ¥æº 1ï¼šå…ƒæ•°æ®æ¨¡å‹å‚æ•°

```python
# OpenWebUI æ³¨å…¥æ¨¡å‹é…ç½®
metadata = body.get("metadata", {})
meta_model = metadata.get("model", {})
meta_params = meta_model.get("params", {})
system_prompt = meta_params.get("system")  # ä¼˜å…ˆçº§ 1
```

### æ¥æº 2ï¼šæ¨¡å‹æ•°æ®åº“

```python
from open_webui.models.models import Models

# å°è¯•å¤šä¸ªæ¨¡å‹ ID å˜ä½“
model_ids_to_try = [
    request_model,                    # "copilotsdk-claude-sonnet-4.5"
    request_model.removeprefix(...),  # "claude-sonnet-4.5"
    real_model_id,                    # æ¥è‡ª valves
]

for mid in model_ids_to_try:
    model_record = Models.get_model_by_id(mid)
    if model_record and hasattr(model_record, "params"):
        system_prompt = model_record.params.get("system")
        if system_prompt:
            break
```

### æ¥æº 3ï¼šBody å‚æ•°

```python
body_params = body.get("params", {})
system_prompt = body_params.get("system")
```

### æ¥æº 4ï¼šç³»ç»Ÿæ¶ˆæ¯

```python
for msg in messages:
    if msg.get("role") == "system":
        system_prompt = self._extract_text_from_content(msg.get("content"))
        break
```

### SessionConfig ä¸­çš„é…ç½®

```python
system_message_config = {
    "mode": "append",           # è¿½åŠ åˆ°å¯¹è¯ä¸Šä¸‹æ–‡
    "content": system_prompt_content
}

session_config = SessionConfig(
    system_message=system_message_config,
    # ... å…¶ä»–å‚æ•°
)
```

---

## é…ç½®å‚æ•°

### Valve å®šä¹‰

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | æè¿° |
|-----|------|--------|------|
| `GH_TOKEN` | str | `""` | GitHub ç²¾ç»†åŒ–ä»¤ç‰Œï¼ˆéœ€è¦ 'Copilot Requests' æƒé™ï¼‰ |
| `MODEL_ID` | str | `"claude-sonnet-4.5"` | åŠ¨æ€è·å–å¤±è´¥æ—¶çš„é»˜è®¤æ¨¡å‹ |
| `CLI_PATH` | str | `"/usr/local/bin/copilot"` | Copilot CLI äºŒè¿›åˆ¶æ–‡ä»¶è·¯å¾„ |
| `DEBUG` | bool | `False` | å¯ç”¨å‰ç«¯æ§åˆ¶å°è°ƒè¯•æ—¥å¿— |
| `LOG_LEVEL` | str | `"error"` | CLI æ—¥å¿—çº§åˆ«ï¼šnoneã€errorã€warningã€infoã€debugã€all |
| `SHOW_THINKING` | bool | `True` | åœ¨ `<think>` æ ‡ç­¾ä¸­æ˜¾ç¤ºæ¨¡å‹æ¨ç† |
| `SHOW_WORKSPACE_INFO` | bool | `True` | åœ¨è°ƒè¯•æ¨¡å¼ä¸‹æ˜¾ç¤ºä¼šè¯å·¥ä½œåŒºè·¯å¾„ |
| `EXCLUDE_KEYWORDS` | str | `""` | é€—å·åˆ†éš”çš„å…³é”®å­—ï¼Œç”¨äºæ’é™¤æ¨¡å‹ |
| `WORKSPACE_DIR` | str | `""` | é™åˆ¶çš„å·¥ä½œåŒºç›®å½•ï¼ˆç©º = è¿›ç¨‹ cwdï¼‰ |
| `INFINITE_SESSION` | bool | `True` | å¯ç”¨è‡ªåŠ¨ä¸Šä¸‹æ–‡å‹ç¼© |
| `COMPACTION_THRESHOLD` | float | `0.8` | 80% token ä½¿ç”¨ç‡æ—¶åå°å‹ç¼© |
| `BUFFER_THRESHOLD` | float | `0.95` | 95% ç´§æ€¥é˜ˆå€¼ |
| `TIMEOUT` | int | `300` | æµå—è¶…æ—¶ï¼ˆç§’ï¼‰ |
| `CUSTOM_ENV_VARS` | str | `""` | è‡ªå®šä¹‰ç¯å¢ƒå˜é‡çš„ JSON å­—ç¬¦ä¸² |
| `ENABLE_TOOLS` | bool | `False` | å¯ç”¨è‡ªå®šä¹‰å·¥å…·ç³»ç»Ÿ |
| `AVAILABLE_TOOLS` | str | `"all"` | å¯ç”¨å·¥å…·ï¼š"all" æˆ–é€—å·åˆ†éš”åˆ—è¡¨ |

### ç¯å¢ƒå˜é‡

```bash
# ç”± _setup_env è®¾ç½®
export COPILOT_CLI_PATH="/usr/local/bin/copilot"
export GH_TOKEN="ghp_xxxxxxxxxxxxxxxxxxxx"
export GITHUB_TOKEN="ghp_xxxxxxxxxxxxxxxxxxxx"

# è‡ªå®šä¹‰å˜é‡ï¼ˆæ¥è‡ª CUSTOM_ENV_VARS valveï¼‰
export CUSTOM_VAR_1="value1"
export CUSTOM_VAR_2="value2"
```

---

## æ ¸å¿ƒå‡½æ•°å‚è€ƒ

### å…¥å£ç‚¹

#### `pipe(body, __metadata__, __event_emitter__, __event_call__)`

- **ç›®çš„**ï¼šOpenWebUI ç¨³å®šå…¥å£ç‚¹
- **è¿”å›**ï¼šå§”æ‰˜ç»™ `_pipe_impl`

#### `_pipe_impl(body, __metadata__, __event_emitter__, __event_call__)`

- **ç›®çš„**ï¼šä¸»è¯·æ±‚å¤„ç†é€»è¾‘
- **æµç¨‹**ï¼šè®¾ç½® â†’ æå– â†’ ä¼šè¯ â†’ å“åº”
- **è¿”å›**ï¼š`str`ï¼ˆéæµå¼ï¼‰æˆ– `AsyncGenerator`ï¼ˆæµå¼ï¼‰

#### `pipes()`

- **ç›®çš„**ï¼šåŠ¨æ€æ¨¡å‹åˆ—è¡¨è·å–
- **è¿”å›**ï¼šå¸¦æœ‰å€æ•°ä¿¡æ¯çš„å¯ç”¨æ¨¡å‹åˆ—è¡¨
- **ç¼“å­˜**ï¼šä½¿ç”¨ `_model_cache` é¿å…é‡å¤ API è°ƒç”¨

### ä¼šè¯ç®¡ç†

#### `_build_session_config(chat_id, real_model_id, custom_tools, system_prompt_content, is_streaming)`

- **ç›®çš„**ï¼šæ„å»º SessionConfig å¯¹è±¡
- **è¿”å›**ï¼šå¸¦æœ‰æ— é™ä¼šè¯å’Œå·¥å…·çš„ `SessionConfig`

#### `_get_chat_context(body, __metadata__, __event_call__)`

- **ç›®çš„**ï¼šä½¿ç”¨ä¼˜å…ˆçº§å›é€€æå– chat_id
- **è¿”å›**ï¼š`{"chat_id": str}`

### æµå¼ä¼ è¾“

#### `stream_response(client, session, send_payload, init_message, __event_call__)`

- **ç›®çš„**ï¼šå¼‚æ­¥æµå¼äº‹ä»¶å¤„ç†å™¨
- **äº§å‡º**ï¼šæ–‡æœ¬å—åˆ° OpenWebUI
- **èµ„æº**ï¼šè‡ªåŠ¨æ¸…ç†å®¢æˆ·ç«¯å’Œä¼šè¯

#### `handler(event)`

- **ç›®çš„**ï¼šåŒæ­¥äº‹ä»¶å›è°ƒï¼ˆåœ¨ `stream_response` å†…ï¼‰
- **æ“ä½œ**ï¼šè§£æäº‹ä»¶ â†’ å…¥é˜Ÿå— â†’ æ›´æ–°çŠ¶æ€

### è¾…åŠ©å‡½æ•°

#### `_emit_debug_log(message, __event_call__)`

- **ç›®çš„**ï¼šå°†è°ƒè¯•æ—¥å¿—å‘é€åˆ°å‰ç«¯æ§åˆ¶å°
- **æ¡ä»¶**ï¼šä»…å½“ `DEBUG=True` æ—¶

#### `_setup_env(__event_call__)`

- **ç›®çš„**ï¼šå®šä½ CLIï¼Œè®¾ç½®ç¯å¢ƒå˜é‡
- **å‰¯ä½œç”¨**ï¼šä¿®æ”¹ `os.environ`

#### `_extract_system_prompt(body, messages, request_model, real_model_id, __event_call__)`

- **ç›®çš„**ï¼šå¤šæºç³»ç»Ÿæç¤ºè¯æå–
- **è¿”å›**ï¼š`(system_prompt_content, source_name)`

#### `_process_images(messages, __event_call__)`

- **ç›®çš„**ï¼šä»å¤šæ¨¡æ€æ¶ˆæ¯ä¸­æå–æ–‡æœ¬å’Œå›¾ç‰‡
- **è¿”å›**ï¼š`(text_content, attachments_list)`

#### `_initialize_custom_tools()`

- **ç›®çš„**ï¼šæ³¨å†Œå’Œè¿‡æ»¤è‡ªå®šä¹‰å·¥å…·
- **è¿”å›**ï¼šå·¥å…·å‡½æ•°åˆ—è¡¨

### å®ç”¨å‡½æ•°

#### `get_event_type(event) -> str`

- **ç›®çš„**ï¼šä»æšä¸¾/å­—ç¬¦ä¸²æå–äº‹ä»¶ç±»å‹å­—ç¬¦ä¸²
- **å¤„ç†**ï¼š`SessionEventType` æšä¸¾ â†’ `.value` æå–

#### `safe_get_data_attr(event, attr: str, default=None)`

- **ç›®çš„**ï¼šä» event.data å®‰å…¨æå–å±æ€§
- **å¤„ç†**ï¼šdict è®¿é—®å’Œå¯¹è±¡å±æ€§è®¿é—®

---

## æ•…éšœæ’é™¤æŒ‡å—

### å¯ç”¨è°ƒè¯•æ¨¡å¼

```python
# åœ¨ OpenWebUI Valves UI ä¸­ï¼š
DEBUG = True
SHOW_WORKSPACE_INFO = True
LOG_LEVEL = "debug"
```

### è°ƒè¯•è¾“å‡ºä½ç½®

**å‰ç«¯æ§åˆ¶å°ï¼š**

```javascript
// æ‰“å¼€æµè§ˆå™¨å¼€å‘å·¥å…· (F12)
// æŸ¥æ‰¾å‰ç¼€ä¸º [Copilot Pipe] çš„æ—¥å¿—
console.debug("[Copilot Pipe] æå–çš„ ChatIDï¼šabc123ï¼ˆæ¥æºï¼š__metadata__ï¼‰")
```

**åç«¯æ—¥å¿—ï¼š**

```python
# Python æ—¥å¿—è¾“å‡º
logger.debug(f"[Copilot Pipe] ä¼šè¯å·²æ¢å¤ï¼š{chat_id}")
```

### å¸¸è§é—®é¢˜

#### 1. ä¼šè¯æœªæ¢å¤

**ç—‡çŠ¶**ï¼šæ¯æ¬¡è¯·æ±‚éƒ½åˆ›å»ºæ–°ä¼šè¯  
**åŸå› **ï¼š

- `chat_id` æå–ä¸æ­£ç¡®
- Copilot ç«¯ä¼šè¯è¿‡æœŸ
- `INFINITE_SESSION=False`ï¼ˆä¼šè¯ä¸æŒä¹…ï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼š

```python
# æ£€æŸ¥è°ƒè¯•æ—¥å¿—ä¸­çš„ï¼š
"æå–çš„ ChatIDï¼š<id>ï¼ˆæ¥æºï¼š...ï¼‰"
"ä¼šè¯ <id> æœªæ‰¾åˆ°ï¼ˆ...ï¼‰ï¼Œæ­£åœ¨åˆ›å»ºæ–°ä¼šè¯ã€‚"
```

#### 2. ç³»ç»Ÿæç¤ºè¯æœªåº”ç”¨

**ç—‡çŠ¶**ï¼šæ¨¡å‹å¿½ç•¥é…ç½®çš„ç³»ç»Ÿæç¤ºè¯  
**åŸå› **ï¼š

- åœ¨ 4 ä¸ªæ¥æºä¸­å‡æœªæ‰¾åˆ°
- ä¼šè¯å·²æ¢å¤ï¼ˆç³»ç»Ÿæç¤ºè¯ä»…åœ¨åˆ›å»ºæ—¶è®¾ç½®ï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼š

```python
# æ£€æŸ¥è°ƒè¯•æ—¥å¿—ä¸­çš„ï¼š
"ä» <source> æå–ç³»ç»Ÿæç¤ºè¯ï¼ˆé•¿åº¦ï¼šXï¼‰"
"é…ç½®ç³»ç»Ÿæ¶ˆæ¯ï¼ˆæ¨¡å¼ï¼šappendï¼‰"
```

#### 3. å·¥å…·ä¸å¯ç”¨

**ç—‡çŠ¶**ï¼šæ¨¡å‹æ— æ³•ä½¿ç”¨è‡ªå®šä¹‰å·¥å…·  
**åŸå› **ï¼š

- `ENABLE_TOOLS=False`
- å·¥å…·æœªåœ¨ `_initialize_custom_tools` ä¸­æ³¨å†Œ
- é”™è¯¯çš„ `AVAILABLE_TOOLS` è¿‡æ»¤å™¨

**è§£å†³æ–¹æ¡ˆ**ï¼š

```python
# æ£€æŸ¥è°ƒè¯•æ—¥å¿—ä¸­çš„ï¼š
"å·²å¯ç”¨ X ä¸ªè‡ªå®šä¹‰å·¥å…·ï¼š['tool1', 'tool2']"
```

---

## æ€§èƒ½ä¼˜åŒ–

### æ¨¡å‹åˆ—è¡¨ç¼“å­˜

```python
# ç¬¬ä¸€æ¬¡è¯·æ±‚ï¼šä» API è·å–
models = await client.list_models()
self._model_cache = [...]  # ç¼“å­˜ç»“æœ

# åç»­è¯·æ±‚ï¼šä½¿ç”¨ç¼“å­˜
if self._model_cache:
    return self._model_cache
```

### ä¼šè¯æŒä¹…åŒ–

**å½±å“**ï¼šæ¶ˆé™¤æ¯æ¬¡è¯·æ±‚çš„å†—ä½™æ¨¡å‹åˆå§‹åŒ–

```python
# æ²¡æœ‰ä¼šè¯ï¼š
# æ¯æ¬¡è¯·æ±‚ï¼šåˆå§‹åŒ–æ¨¡å‹ â†’ åŠ è½½ä¸Šä¸‹æ–‡ â†’ ç”Ÿæˆ â†’ ä¸¢å¼ƒ

# æœ‰ä¼šè¯ï¼ˆchat_idï¼‰ï¼š
# ç¬¬ä¸€æ¬¡è¯·æ±‚ï¼šåˆå§‹åŒ–æ¨¡å‹ â†’ åŠ è½½ä¸Šä¸‹æ–‡ â†’ ç”Ÿæˆ â†’ ä¿å­˜
# åç»­ï¼šæ¢å¤ â†’ ç”Ÿæˆï¼ˆå³æ—¶ï¼‰
```

### æµå¼ vs éæµå¼

**æµå¼ï¼š**

- é™ä½æ„ŸçŸ¥å»¶è¿Ÿï¼ˆé¦–ä¸ª token æ›´å¿«ï¼‰
- é•¿å“åº”çš„æ›´å¥½ç”¨æˆ·ä½“éªŒ
- é€šè¿‡ç”Ÿæˆå™¨é€€å‡ºè¿›è¡Œèµ„æºæ¸…ç†

**éæµå¼ï¼š**

- æ›´ç®€å•çš„é”™è¯¯å¤„ç†
- åŸå­å“åº”ï¼ˆæ— éƒ¨åˆ†è¾“å‡ºï¼‰
- ç”¨äºçŸ­å“åº”

---

## å®‰å…¨è€ƒè™‘

### ä»¤ç‰Œä¿æŠ¤

```python
# âŒ æ°¸è¿œä¸è¦è®°å½•ä»¤ç‰Œ
logger.debug(f"ä»¤ç‰Œï¼š{self.valves.GH_TOKEN}")  # ä¸è¦è¿™æ ·åš

# âœ… å±è”½æ•æ„Ÿæ•°æ®
logger.debug(f"ä»¤ç‰Œå·²é…ç½®ï¼š{'*' * 10}")
```

### å·¥ä½œåŒºéš”ç¦»

```python
# è®¾ç½® WORKSPACE_DIR ä»¥é™åˆ¶æ–‡ä»¶è®¿é—®
WORKSPACE_DIR = "/safe/sandbox/path"

# Copilot CLI éµå®ˆæ­¤ç›®å½•
client_config["cwd"] = WORKSPACE_DIR
```

### è¾“å…¥éªŒè¯

```python
# éªŒè¯ chat_id æ ¼å¼
if chat_id and not re.match(r'^[a-zA-Z0-9_-]+$', chat_id):
    logger.warning(f"æ— æ•ˆçš„ chat_id æ ¼å¼ï¼š{chat_id}")
    chat_id = None
```

---

## æœªæ¥å¢å¼º

### è®¡åˆ’åŠŸèƒ½

1. **å¤šä¼šè¯ç®¡ç†**ï¼šæ”¯æŒæ¯ä¸ªç”¨æˆ·çš„å¤šä¸ªå¹¶è¡Œä¼šè¯
2. **ä¼šè¯åˆ†æ**ï¼šè·Ÿè¸ª token ä½¿ç”¨ç‡ã€å‹ç¼©é¢‘ç‡
3. **å·¥å…·ç»“æœç¼“å­˜**ï¼šé¿å…å†—ä½™å·¥å…·è°ƒç”¨
4. **è‡ªå®šä¹‰äº‹ä»¶è¿‡æ»¤å™¨**ï¼šç”¨æˆ·å¯é…ç½®çš„äº‹ä»¶å¤„ç†
5. **å·¥ä½œåŒºæ¨¡æ¿**ï¼šé¢„é…ç½®çš„å·¥ä½œåŒºç¯å¢ƒ
6. **æµå¼ä¸­æ­¢**ï¼šä¼˜é›…å–æ¶ˆé•¿æ—¶é—´è¿è¡Œçš„è¯·æ±‚

### API æ¼”è¿›

ç›‘æ§ Copilot SDK æ›´æ–°ï¼š

- æ–°äº‹ä»¶ç±»å‹ï¼ˆä¾‹å¦‚ `assistant.function_call`ï¼‰
- å¢å¼ºçš„å·¥å…·åŠŸèƒ½
- æ”¹è¿›çš„ä¼šè¯åºåˆ—åŒ–

---

## å‚è€ƒèµ„æ–™

- [GitHub Copilot SDK æ–‡æ¡£](https://github.com/github/copilot-sdk)
- [OpenWebUI Pipe å¼€å‘](https://docs.openwebui.com/)
- [Awesome OpenWebUI é¡¹ç›®](https://github.com/Fu-Jie/awesome-openwebui)

---

**è®¸å¯è¯**ï¼šMIT  
**ç»´æŠ¤è€…**ï¼šFu-Jie ([@Fu-Jie](https://github.com/Fu-Jie))
